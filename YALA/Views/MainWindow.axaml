<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:YALA.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="YALA.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/logo-YALA.ico"
		xmlns:conv="using:YALA.Converters"
        xmlns:lucide="clr-namespace:Lucide.Avalonia;assembly=Lucide.Avalonia"
		xmlns:views="clr-namespace:YALA.Views;assembly=YALA"
		xmlns:cp="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls.ColorPicker"
		xmlns:controls="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls"
		xmlns:paz="using:Avalonia.Controls.PanAndZoom"
        Title="YALA"
		RequestedThemeVariant="Dark"
		KeyDown="OnKeyDown"
		KeyUp="OnKeyUp"
        Background="{DynamicResource BackgroundBrush}">

	<Window.Resources>
		<conv:HexToColorConverter x:Key="HexToColorConverter"/>
		<conv:HexToBrushConverter x:Key="HexToBrushConverter"/>
		<conv:HalfSizeOffsetConverter x:Key="HalfWidthOffsetConverter" />
		<conv:HalfSizeOffsetConverter x:Key="HalfHeightOffsetConverter" />
		<conv:DoubleToIntConverter x:Key="DoubleToIntConverter"/>
	</Window.Resources>

	<Grid RowDefinitions="Auto,*, Auto" x:Name="MainFocusTarget" Focusable="True">
		<!-- Top Menu Bar And Controls-->
		<Border Background="{DynamicResource MenuBackGroundBrush}" Padding="0,0,0,10">
			<Grid ColumnDefinitions="*,Auto,*" >
				<Menu>
					<MenuItem Header="Project">
						<MenuItem Header="Create new" Click="OnCreateNewProjectClick"/>
						<MenuItem Header="Open existing" Click="OnOpenExistingProjectClick" />
						<MenuItem Header="Close current" Command="{Binding CloseCurrentProjectCommand}"/>
						<Separator/>
						<MenuItem Header="Add images" Click="OnAddImagesClicked" />
					</MenuItem>
					<MenuItem Header="Inference">
						<MenuItem Header="Open YOLO .pt"/>
						<MenuItem Header="Run on all project"/>
					</MenuItem>
					<MenuItem Header="Edit">
						<MenuItem Header="Copy"/>
						<MenuItem Header="Paste" />
					</MenuItem>
				</Menu>

				<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5">
					<Button Classes="icon-button" ToolTip.Tip="Previous Image" Tag="25" Content="ChevronLeft" Command="{Binding PreviousImageCommand}"/>
					<Button Classes="icon-button" ToolTip.Tip="Next Image" Tag="25" Content="ChevronRight" Command="{Binding NextImageCommand}"/>
					<ToggleButton Classes="icon-button" ToolTip.Tip="Rectangle Tool" Content="SquarePen"/>
					<Button Classes="icon-button" ToolTip.Tip="Auto Detect This Image" Content="WandSparkles"/>
					<Button Classes="icon-button" ToolTip.Tip="Reset Pan And Zoom" Content="Fullscreen" Click="ResetZoomButtonClicked"/>
				</StackPanel>
			</Grid>
		</Border>

		<!-- Main Content -->
		<Grid Grid.Row="1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto" MaxWidth="400" />
			</Grid.ColumnDefinitions>

			<!-- Image Display Area -->
			<Grid Grid.Column="0">
				<ScrollViewer HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible">
					<paz:ZoomBorder Name="ZoomBorder" Stretch="None" ZoomSpeed="1.2" VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
						<Grid x:Name="ImageLayer">
							<Viewbox Stretch="Uniform">
								<Grid>
									<Image x:Name="MainImage"
										   Source="{Binding CurrentImageBitmap}"/>
									<Canvas x:Name="BoundingBoxesCanvas"
											Background="Transparent"
											PointerPressed="BoundingBoxesCanvas_PointerPressed"
											PointerMoved="BoundingBoxesCanvas_PointerMoved"/>
								</Grid>
							</Viewbox>
						</Grid>
					</paz:ZoomBorder>
				</ScrollViewer>
			</Grid>

			<!-- Side Panel -->
			<ScrollViewer Grid.Column="1" Background="{DynamicResource PanelBackgroundBrush}">
				<StackPanel Spacing="10" Margin="5">
					<Border Background="{DynamicResource BackgroundBrush}" Padding="8" CornerRadius="5">
						<StackPanel Spacing="5">
							<TextBlock Text="Image Information" FontWeight="Bold" FontSize="14"/>
							<TextBlock>
								<Run Text="Size: "/>
								<Run Text="{Binding CurrentImageBitmap.Size.Width}"/>
								<Run Text=" x "/>
								<Run Text="{Binding CurrentImageBitmap.Size.Height}"/>
							</TextBlock>
							<StackPanel Orientation="Horizontal" Spacing="4">
								<TextBlock VerticalAlignment="Center" Text="Current: "/>
								<TextBox x:Name="ImageIndexTextBox" Width="40"
										 Text="{Binding CurrentImageIndex}"
										 HorizontalAlignment="Left"
										 VerticalContentAlignment="Center"
										 TextChanged="OnCurrentImageIndexChanged"/>
								<TextBlock VerticalAlignment="Center" Text="/"/>
								<TextBlock VerticalAlignment="Center" Text="{Binding ImagesPaths.Count}"/>
							</StackPanel>
						</StackPanel>
					</Border>

					<!--Classes-->
					<Border Background="{DynamicResource BackgroundBrush}" Padding="8" CornerRadius="5">
						<StackPanel Spacing="8">
							<TextBlock Text="Classes" FontWeight="Bold" FontSize="14"/>
							<StackPanel>
								<ItemsControl ItemsSource="{Binding LabelingClasses}">
									<ItemsControl.ItemsPanel>
										<ItemsPanelTemplate>
											<StackPanel Spacing="8"/>
										</ItemsPanelTemplate>
									</ItemsControl.ItemsPanel>
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="5">
												<Grid ColumnDefinitions="Auto,*,Auto,Auto" VerticalAlignment="Center">
													<Button Grid.ColumnSpan="3"
															Background="Transparent"
															BorderThickness="0"
															Padding="8"
															Click="OnClassChecked">
														<Grid ColumnDefinitions="Auto,*,Auto">
															<RadioButton Grid.Column="0"
																		 IsChecked="{Binding IsSelected}"
																		 Margin="0"
																		 VerticalAlignment="Center"/>
															<TextBlock Grid.Column="1" Text="{Binding Name}" Margin="4,0" VerticalAlignment="Center"/>
															<TextBlock Grid.Column="2" Margin="4,0" VerticalAlignment="Center">
																<Run Text="(Id: "/>
																<Run Text="{Binding Id}"/>
																<Run Text=", Instances: "/>
																<Run Text="{Binding NumberOfInstances}"/>
																<Run Text=")"/>
															</TextBlock>
														</Grid>
													</Button>

													<cp:ColorPicker Grid.Column="3"
																	Color="{Binding Color, Converter={StaticResource HexToColorConverter}}"
																	HorizontalAlignment="Stretch"
																	IsAlphaEnabled="False"
																	Margin="0,0,5,0"
																	IsAlphaVisible="False"
																	VerticalAlignment="Stretch"
																	ColorChanged="OnColorChanged"/>
												</Grid>
											</Border>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</StackPanel>
						</StackPanel>
					</Border>

					<!-- Annotations -->
					<Border Background="{DynamicResource BackgroundBrush}" Padding="8" CornerRadius="5">
						<StackPanel Spacing="8">
							<StackPanel Orientation="Horizontal" Spacing="10">
								<TextBlock Text="Annotations" FontWeight="Bold" FontSize="14"/>
								<CheckBox Checked="ShowAllEditingThumbsChecked" Unchecked="ShowAllEditingThumbsUnchecked" Content="Always show resize thumbs" IsChecked="true" />
							</StackPanel>
							<ItemsControl ItemsSource="{Binding CurrentImageBoundingBoxes}">
								<ItemsControl.ItemTemplate>
									<DataTemplate>
										<Border Background="{DynamicResource PanelBackgroundBrush}" Padding="8" CornerRadius="5" Margin="0,0,0,4">
											<Grid ColumnDefinitions="Auto,*,Auto">
												<Rectangle Width="16" Height="16"
														   Fill="{Binding Color, Converter={StaticResource HexToBrushConverter}}"
														   Margin="0,0,8,0"/>
												<StackPanel Grid.Column="1">
													<TextBlock Text="{Binding ClassName}"/>
													<TextBlock FontWeight="Medium" FontSize="12" Text="{Binding Tlx, StringFormat=({0}, }">
														<TextBlock.Text>
															<MultiBinding StringFormat="({0}, {1}) {2}Ã—{3}">
																<Binding Path="Tlx" Converter="{StaticResource DoubleToIntConverter}"/>
																<Binding Path="Tly" Converter="{StaticResource DoubleToIntConverter}"/>
																<Binding Path="Width" Converter="{StaticResource DoubleToIntConverter}"/>
																<Binding Path="Height" Converter="{StaticResource DoubleToIntConverter}"/>
															</MultiBinding>
														</TextBlock.Text>
													</TextBlock>
												</StackPanel>
												<StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="3">
													<Button Classes="icon-button" ToolTip.Tip="Edit" Content="Pencil"
															Click="OnEditBoundingBoxClicked" Tag="{Binding}"/>
													<Button Classes="icon-button"
															ToolTip.Tip="Delete"
															Content="Trash2"
															Click="OnDeleteBoundingBoxClicked"
															Tag="{Binding}" />

												</StackPanel>
											</Grid>
										</Border>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</StackPanel>
					</Border>

				</StackPanel>
			</ScrollViewer>
		</Grid>
		<StackPanel Orientation="Horizontal" Grid.Row="2" Margin="5" >
			<Label x:Name="MousePositionLabel" Content="(0, 0)" FontSize="12" Margin="10"/>
			<TextBlock Text="{Binding CurrentImageAbsolutePath, StringFormat='Image path: {0}'}"/>
		</StackPanel>
	</Grid>
</Window>